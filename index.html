<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>gogadget - Repair Management</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #4a5568;
            --primary-hover: #2d3748;
            --success: #16a34a;
            --warning: #f59e0b;
            --danger: #dc2626;
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #111111;
            --text-light: #374151;
            --border: #e2e8f0;
            --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
            --shadow-lg: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.06);
            --radius: 8px;
        }

        body {
            font-family: 'DM Sans', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* Login Screen */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-card {
            background: var(--card);
            padding: 40px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 400px;
        }

        .login-logo {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            text-align: center;
            margin-bottom: 8px;
        }

        .login-subtitle {
            text-align: center;
            color: var(--text-light);
            margin-bottom: 32px;
        }

        /* Main App */
        .app {
            display: none;
        }

        .app.active {
            display: block;
        }

        /* Header */
        .header {
            background: var(--card);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-inner {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
        }

        .logo {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary);
        }

        .search-box {
            flex: 1;
            max-width: 500px;
            min-width: 200px;
        }

        .search-input {
            width: 100%;
            padding: 10px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .user-info {
            font-size: 14px;
            color: var(--text-light);
        }

        /* Buttons */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-secondary {
            background: white;
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-icon {
            padding: 8px;
            min-width: 36px;
            justify-content: center;
        }

        /* Main Content */
        .main {
            max-width: 900px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Nav Tabs */
        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 10px 20px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 500;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-tab:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .nav-tab.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Cards */
        .card {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
        }

        .card-body {
            padding: 20px;
        }

        /* Grid Layout */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-light);
            margin-bottom: 6px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 500px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Tables */
        .table-wrap {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: #fafafa;
        }

        tr:hover {
            background: #fafafa;
        }

        tr.clickable {
            cursor: pointer;
        }

        /* Status Badges */
        .status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-received { background: #e0f2fe; color: #0369a1; }
        .status-diagnosing { background: #fef3c7; color: #b45309; }
        .status-in_progress { background: #dbeafe; color: #1d4ed8; }
        .status-waiting_parts { background: #fee2e2; color: #b91c1c; }
        .status-ready_pickup { background: #d1fae5; color: #047857; }
        .status-completed { background: #dcfce7; color: #15803d; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--card);
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-lg {
            max-width: 800px;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
            line-height: 1;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Signature Pad */
        .signature-container {
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: #fafafa;
            margin-bottom: 10px;
        }

        #signaturePad {
            width: 100%;
            height: 150px;
            cursor: crosshair;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--card);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-light);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text);
        }

        .stat-value.success { color: var(--success); }
        .stat-value.warning { color: var(--warning); }

        /* Ticket Detail */
        .ticket-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .ticket-number {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .ticket-meta {
            font-size: 14px;
            color: var(--text-light);
            margin-top: 4px;
        }

        .ticket-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .info-item label {
            display: block;
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 4px;
        }

        .info-item span {
            font-weight: 500;
        }

        /* Notes */
        .notes-list {
            list-style: none;
        }

        .note-item {
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .note-item:last-child {
            border-bottom: none;
        }

        .note-meta {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 4px;
        }

        .note-text {
            font-size: 14px;
        }

        /* Print Styles */
        .print-ticket {
            display: none;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .print-ticket, .print-ticket * {
                visibility: visible;
            }
            .print-ticket {
                display: block;
                position: absolute;
                left: 0;
                top: 0;
                width: 4in;
                padding: 10px;
            }
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-state h3 {
            margin-bottom: 8px;
            color: var(--text);
        }

        /* Alerts */
        .alert {
            padding: 12px 16px;
            border-radius: var(--radius);
            margin-bottom: 16px;
            font-size: 14px;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        /* Low Stock Warning */
        .low-stock {
            color: var(--danger);
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-inner {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                max-width: none;
                order: 3;
            }
            
            .header-actions {
                justify-content: space-between;
            }
            
            .main {
                padding: 16px;
            }
            
            .nav-tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
                padding-bottom: 8px;
            }
            
            .nav-tab {
                white-space: nowrap;
            }
        }

        /* Customer History */
        .history-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .history-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 12px;
        }

        /* Search Results Dropdown */
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 200;
        }

        .search-results.active {
            display: block;
        }

        .search-result-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: var(--bg);
        }

        .search-result-name {
            font-weight: 500;
        }

        .search-result-meta {
            font-size: 12px;
            color: var(--text-light);
        }

        .search-box {
            position: relative;
        }

        /* QR Code */
        .qr-container {
            text-align: center;
            margin: 20px 0;
        }

        #ticketQR {
            margin: 0 auto;
        }

        /* Terms */
        .terms-box {
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 13px;
            margin-bottom: 16px;
        }

        .terms-check {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 16px;
        }

        .terms-check input {
            margin-top: 3px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <div class="login-logo">gogadget</div>
            <p class="login-subtitle">Repair Management System</p>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="loginEmail" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="loginPassword" class="form-input" required>
                </div>
                <div id="loginError" class="alert alert-warning" style="display: none;"></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Sign In</button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="app">
        <!-- Header -->
        <header class="header">
            <div class="header-inner">
                <div class="logo">gogadget</div>
                <div class="search-box">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search by name, phone, ticket number, or scan QR...">
                    <div id="searchResults" class="search-results"></div>
                </div>
                <div class="header-actions">
                    <span class="user-info" id="userEmail"></span>
                    <button class="btn btn-secondary btn-sm" onclick="logout()">Logout</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main">
            <!-- Navigation -->
            <div class="nav-tabs">
                <button class="nav-tab active" data-tab="dashboard">Dashboard</button>
                <button class="nav-tab" data-tab="newTicket">+ New Ticket</button>
                <button class="nav-tab" data-tab="inventory">Inventory</button>
                <button class="nav-tab" data-tab="statistics">Statistics</button>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboardTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Recent Tickets</h2>
                        <button class="btn btn-primary btn-sm" onclick="showTab('newTicket')">+ New Ticket</button>
                    </div>
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ticket #</th>
                                    <th>Customer</th>
                                    <th>Device</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="recentTickets">
                                <tr><td colspan="5" class="loading">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- New Ticket Tab -->
            <div id="newTicketTab" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Create New Ticket</h2>
                    </div>
                    <div class="card-body">
                        <form id="newTicketForm">
                            <!-- Customer Search or New -->
                            <div class="form-group">
                                <label class="form-label">Find Existing Customer or Enter New</label>
                                <input type="text" id="customerSearch" class="form-input" placeholder="Search by name or phone...">
                                <div id="customerSearchResults" class="search-results" style="position: relative;"></div>
                            </div>
                            
                            <input type="hidden" id="selectedCustomerId">
                            
                            <div id="customerFields">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">First Name *</label>
                                        <input type="text" id="firstName" class="form-input" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Last Name *</label>
                                        <input type="text" id="lastName" class="form-input" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Phone *</label>
                                        <input type="tel" id="phone" class="form-input" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Email</label>
                                        <input type="email" id="email" class="form-input">
                                    </div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Device Type *</label>
                                    <select id="deviceType" class="form-select" required>
                                        <option value="">Select device...</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Serial Number</label>
                                    <input type="text" id="serialNumber" class="form-input">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Issue Description</label>
                                <textarea id="issueDescription" class="form-textarea" placeholder="Describe the problem..."></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Estimated Cost ($)</label>
                                <input type="number" id="estimatedCost" class="form-input" step="0.01" min="0">
                            </div>

                            <!-- Terms and Signature -->
                            <div class="form-group">
                                <label class="form-label">Terms & Conditions</label>
                                <div class="terms-box">
                                    <p><strong>gogadget Repair Terms & Conditions</strong></p>
                                    <br>
                                    <p>1. <strong>Diagnostic Fee:</strong> A non-refundable diagnostic fee may apply if repair is declined.</p>
                                    <br>
                                    <p>2. <strong>Data Backup:</strong> Customer is responsible for backing up all data before service. gogadget is not responsible for any data loss.</p>
                                    <br>
                                    <p>3. <strong>Warranty:</strong> Repairs are covered by a 30-day warranty on parts and labor, unless otherwise specified.</p>
                                    <br>
                                    <p>4. <strong>Abandoned Devices:</strong> Devices not picked up within 30 days of completion notice may be considered abandoned.</p>
                                    <br>
                                    <p>5. <strong>Liability:</strong> gogadget is not liable for any pre-existing damage or issues not related to the repair performed.</p>
                                    <br>
                                    <p>6. <strong>Payment:</strong> Payment is due upon completion of repair before device pickup.</p>
                                </div>
                                <div class="terms-check">
                                    <input type="checkbox" id="termsAgree" required>
                                    <label for="termsAgree">Customer agrees to the terms and conditions</label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Customer Signature</label>
                                <div class="signature-container">
                                    <canvas id="signaturePad"></canvas>
                                </div>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="clearSignature()">Clear Signature</button>
                            </div>

                            <button type="submit" class="btn btn-primary">Create Ticket</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Inventory Tab -->
            <div id="inventoryTab" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Inventory</h2>
                        <button class="btn btn-primary btn-sm" onclick="showAddInventoryModal()">+ Add Part</button>
                    </div>
                    <div id="lowStockAlert"></div>
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>Part Name</th>
                                    <th>SKU</th>
                                    <th>Category</th>
                                    <th>In Stock</th>
                                    <th>Cost</th>
                                    <th>Sell Price</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTable">
                                <tr><td colspan="7" class="loading">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Statistics Tab -->
            <div id="statisticsTab" class="tab-content" style="display: none;">
                <div class="stats-grid" id="statsCards">
                    <!-- Stats will load here -->
                </div>
                
                <div class="grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Repairs by Device</h2>
                        </div>
                        <div class="card-body" id="deviceStats">
                            <div class="loading">Loading...</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Recent Completed</h2>
                        </div>
                        <div class="card-body" id="completedList">
                            <div class="loading">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Ticket Detail Modal -->
    <div id="ticketModal" class="modal-overlay">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 class="modal-title">Ticket Details</h3>
                <button class="modal-close" onclick="closeModal('ticketModal')">&times;</button>
            </div>
            <div class="modal-body" id="ticketModalBody">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Add Inventory Modal -->
    <div id="inventoryModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="inventoryModalTitle">Add Part</h3>
                <button class="modal-close" onclick="closeModal('inventoryModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="inventoryForm">
                    <input type="hidden" id="inventoryId">
                    <div class="form-group">
                        <label class="form-label">Part Name *</label>
                        <input type="text" id="partName" class="form-input" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">SKU</label>
                            <input type="text" id="partSku" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <input type="text" id="partCategory" class="form-input" placeholder="e.g., HDMI, Power, Fan">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Quantity</label>
                            <input type="number" id="partQuantity" class="form-input" value="0" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Min Stock Level</label>
                            <input type="number" id="partMinStock" class="form-input" value="5" min="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Cost Price ($)</label>
                            <input type="number" id="partCost" class="form-input" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sell Price ($)</label>
                            <input type="number" id="partSellPrice" class="form-input" step="0.01" min="0">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('inventoryModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveInventory()">Save</button>
            </div>
        </div>
    </div>

    <!-- Print Ticket Template -->
    <div id="printTicket" class="print-ticket">
        <div style="text-align: center; font-family: Arial, sans-serif;">
            <h2 style="margin: 0; font-size: 18px;">gogadget</h2>
            <p style="margin: 5px 0; font-size: 12px;">Game Console Repair</p>
            <hr style="margin: 10px 0;">
            <p style="font-size: 24px; font-weight: bold; margin: 10px 0;" id="printTicketNumber"></p>
            <div id="printQR" style="margin: 10px auto;"></div>
            <p style="font-size: 14px; margin: 5px 0;" id="printCustomerName"></p>
            <p style="font-size: 14px; margin: 5px 0;" id="printDeviceType"></p>
            <p style="font-size: 12px; margin: 10px 0;" id="printDate"></p>
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURATION - UPDATE THESE VALUES
        // ========================================
        const SUPABASE_URL = 'https://squjvthzvscuamlvmypt.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxdWp2dGh6dnNjdWFtbHZteXB0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxODE3ODIsImV4cCI6MjA4MTc1Nzc4Mn0.MTiEmv7dTlTCc9Ct7Ni8so3pUv7y9MSMmJj1m4jdzEM';
        
        // ========================================
        // Initialize Supabase
        // ========================================
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ========================================
        // Global State
        // ========================================
        let currentUser = null;
        let deviceTypes = [];
        let signaturePad = null;
        let isDrawing = false;
        
        // ========================================
        // Authentication
        // ========================================
        async function checkAuth() {
            const { data: { session } } = await db.auth.getSession();
            if (session) {
                currentUser = session.user;
                showApp();
            }
        }
        
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            const { data, error } = await db.auth.signInWithPassword({ email, password });
            
            if (error) {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            } else {
                currentUser = data.user;
                showApp();
            }
        });
        
        async function logout() {
            await db.auth.signOut();
            currentUser = null;
            document.getElementById('app').classList.remove('active');
            document.getElementById('loginScreen').style.display = 'flex';
        }
        
        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('app').classList.add('active');
            document.getElementById('userEmail').textContent = currentUser.email;
            loadDeviceTypes();
            loadRecentTickets();
            initSignaturePad();
        }
        
        // ========================================
        // Tab Navigation
        // ========================================
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                showTab(tab.dataset.tab);
            });
        });
        
        function showTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}Tab`).style.display = 'block';
            
            // Load data for specific tabs
            if (tabName === 'inventory') loadInventory();
            if (tabName === 'statistics') loadStatistics();
            if (tabName === 'dashboard') loadRecentTickets();
        }
        
        // ========================================
        // Device Types
        // ========================================
        async function loadDeviceTypes() {
            const { data, error } = await db
                .from('device_types')
                .select('*')
                .eq('active', true)
                .order('sort_order');
            
            const select = document.getElementById('deviceType');
            select.innerHTML = '<option value="">Select device...</option>';
            
            if (data && data.length > 0) {
                deviceTypes = data;
                data.forEach(dt => {
                    select.innerHTML += `<option value="${dt.id}">${dt.name}</option>`;
                });
            } else {
                // Fallback hardcoded options if database table is empty
                const fallbackDevices = [
                    'PS5', 'PS5 Slim', 'PS5 Pro', 'PS4', 'PS4 Slim', 'PS4 Pro',
                    'Xbox Series X', 'Xbox Series S', 'Xbox One', 'Xbox One S', 'Xbox One X',
                    'Nintendo Switch', 'Nintendo Switch OLED', 'Nintendo Switch Lite',
                    'Steam Deck', 'iPad', 'iPad Pro', 'iPad Air', 'iPad Mini',
                    'Android Tablet', 'DJI Drone', 'Other'
                ];
                fallbackDevices.forEach(name => {
                    select.innerHTML += `<option value="${name}">${name}</option>`;
                });
            }
        }
        
        // ========================================
        // Recent Tickets
        // ========================================
        async function loadRecentTickets() {
            const { data, error } = await db
                .from('tickets')
                .select(`
                    *,
                    customers (first_name, last_name, phone),
                    device_types (name)
                `)
                .order('created_at', { ascending: false })
                .limit(20);
            
            const tbody = document.getElementById('recentTickets');
            
            if (error || !data.length) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No tickets yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.map(ticket => `
                <tr class="clickable" onclick="openTicket('${ticket.id}')">
                    <td><strong>${ticket.ticket_number}</strong></td>
                    <td>${ticket.customers.first_name} ${ticket.customers.last_name}</td>
                    <td>${ticket.device_types.name}</td>
                    <td><span class="status status-${ticket.status}">${formatStatus(ticket.status)}</span></td>
                    <td>${formatDate(ticket.created_at)}</td>
                </tr>
            `).join('');
        }
        
        // ========================================
        // Search
        // ========================================
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            
            if (query.length < 2) {
                document.getElementById('searchResults').classList.remove('active');
                return;
            }
            
            searchTimeout = setTimeout(() => performSearch(query), 300);
        });
        
        async function performSearch(query) {
            const resultsDiv = document.getElementById('searchResults');
            
            // Check if it's a ticket number
            if (query.toUpperCase().startsWith('G-')) {
                const { data: tickets } = await db
                    .from('tickets')
                    .select(`*, customers (first_name, last_name), device_types (name)`)
                    .ilike('ticket_number', `%${query}%`)
                    .limit(5);
                
                if (tickets && tickets.length) {
                    resultsDiv.innerHTML = tickets.map(t => `
                        <div class="search-result-item" onclick="openTicket('${t.id}')">
                            <div class="search-result-name">${t.ticket_number}</div>
                            <div class="search-result-meta">${t.customers.first_name} ${t.customers.last_name} - ${t.device_types.name}</div>
                        </div>
                    `).join('');
                    resultsDiv.classList.add('active');
                    return;
                }
            }
            
            // Search customers
            const { data: customers } = await db
                .from('customers')
                .select('*')
                .or(`first_name.ilike.%${query}%,last_name.ilike.%${query}%,phone.ilike.%${query}%`)
                .limit(10);
            
            if (customers && customers.length) {
                resultsDiv.innerHTML = customers.map(c => `
                    <div class="search-result-item" onclick="openCustomer('${c.id}')">
                        <div class="search-result-name">${c.first_name} ${c.last_name}</div>
                        <div class="search-result-meta">${c.phone} ${c.email ? 'Â· ' + c.email : ''}</div>
                    </div>
                `).join('');
                resultsDiv.classList.add('active');
            } else {
                resultsDiv.innerHTML = '<div class="search-result-item">No results found</div>';
                resultsDiv.classList.add('active');
            }
        }
        
        // Close search results when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-box')) {
                document.getElementById('searchResults').classList.remove('active');
            }
        });
        
        // ========================================
        // Customer Search for New Ticket
        // ========================================
        document.getElementById('customerSearch').addEventListener('input', async (e) => {
            const query = e.target.value.trim();
            const resultsDiv = document.getElementById('customerSearchResults');
            
            if (query.length < 2) {
                resultsDiv.classList.remove('active');
                document.getElementById('selectedCustomerId').value = '';
                return;
            }
            
            const { data: customers } = await db
                .from('customers')
                .select('*')
                .or(`first_name.ilike.%${query}%,last_name.ilike.%${query}%,phone.ilike.%${query}%`)
                .limit(5);
            
            if (customers && customers.length) {
                resultsDiv.innerHTML = customers.map(c => `
                    <div class="search-result-item" onclick="selectCustomer('${c.id}', '${c.first_name}', '${c.last_name}', '${c.phone}', '${c.email || ''}')">
                        <div class="search-result-name">${c.first_name} ${c.last_name}</div>
                        <div class="search-result-meta">${c.phone}</div>
                    </div>
                `).join('');
                resultsDiv.innerHTML += `<div class="search-result-item" onclick="clearCustomerSelection()"><em>+ Add as new customer</em></div>`;
                resultsDiv.classList.add('active');
            } else {
                resultsDiv.classList.remove('active');
            }
        });
        
        function selectCustomer(id, firstName, lastName, phone, email) {
            document.getElementById('selectedCustomerId').value = id;
            document.getElementById('firstName').value = firstName;
            document.getElementById('lastName').value = lastName;
            document.getElementById('phone').value = phone;
            document.getElementById('email').value = email;
            document.getElementById('customerSearch').value = `${firstName} ${lastName}`;
            document.getElementById('customerSearchResults').classList.remove('active');
            
            // Disable customer fields
            document.getElementById('firstName').disabled = true;
            document.getElementById('lastName').disabled = true;
            document.getElementById('phone').disabled = true;
            document.getElementById('email').disabled = true;
        }
        
        function clearCustomerSelection() {
            document.getElementById('selectedCustomerId').value = '';
            document.getElementById('firstName').value = '';
            document.getElementById('lastName').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('email').value = '';
            document.getElementById('firstName').disabled = false;
            document.getElementById('lastName').disabled = false;
            document.getElementById('phone').disabled = false;
            document.getElementById('email').disabled = false;
            document.getElementById('customerSearchResults').classList.remove('active');
        }
        
        // ========================================
        // Signature Pad
        // ========================================
        function initSignaturePad() {
            const canvas = document.getElementById('signaturePad');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width - 2;
            canvas.height = 150;
            
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            
            let lastX, lastY;
            
            function getPos(e) {
                const rect = canvas.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                return { x, y };
            }
            
            function startDraw(e) {
                isDrawing = true;
                const pos = getPos(e);
                lastX = pos.x;
                lastY = pos.y;
            }
            
            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                const pos = getPos(e);
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                lastX = pos.x;
                lastY = pos.y;
            }
            
            function stopDraw() {
                isDrawing = false;
            }
            
            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDraw);
            canvas.addEventListener('mouseout', stopDraw);
            
            canvas.addEventListener('touchstart', startDraw);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDraw);
        }
        
        function clearSignature() {
            const canvas = document.getElementById('signaturePad');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        function getSignatureData() {
            const canvas = document.getElementById('signaturePad');
            return canvas.toDataURL();
        }
        
        // ========================================
        // Create Ticket
        // ========================================
        document.getElementById('newTicketForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            let customerId = document.getElementById('selectedCustomerId').value;
            
            // Create new customer if needed
            if (!customerId) {
                const { data: newCustomer, error: customerError } = await db
                    .from('customers')
                    .insert({
                        first_name: document.getElementById('firstName').value,
                        last_name: document.getElementById('lastName').value,
                        phone: document.getElementById('phone').value,
                        email: document.getElementById('email').value || null
                    })
                    .select()
                    .single();
                
                if (customerError) {
                    alert('Error creating customer: ' + customerError.message);
                    return;
                }
                customerId = newCustomer.id;
            }
            
            // Generate ticket number
            const { data: ticketNum } = await db.rpc('generate_ticket_number');
            
            // Create ticket
            const { data: ticket, error: ticketError } = await db
                .from('tickets')
                .insert({
                    ticket_number: ticketNum,
                    customer_id: customerId,
                    device_type_id: document.getElementById('deviceType').value,
                    device_serial: document.getElementById('serialNumber').value || null,
                    issue_description: document.getElementById('issueDescription').value || null,
                    repair_cost: document.getElementById('estimatedCost').value || null,
                    estimated_completion: null,
                    terms_signed: document.getElementById('termsAgree').checked,
                    terms_signed_at: new Date().toISOString(),
                    signature_data: getSignatureData(),
                    status: 'received'
                })
                .select(`*, customers (first_name, last_name), device_types (name)`)
                .single();
            
            if (ticketError) {
                alert('Error creating ticket: ' + ticketError.message);
                return;
            }
            
            // Show success and print option
            alert(`Ticket ${ticketNum} created successfully!`);
            
            // Ask to print
            if (confirm('Print ticket sticker?')) {
                printTicketSticker(ticket);
            }
            
            // Reset form
            e.target.reset();
            clearCustomerSelection();
            clearSignature();
            showTab('dashboard');
        });
        
        // ========================================
        // Print Ticket
        // ========================================
        function printTicketSticker(ticket) {
            document.getElementById('printTicketNumber').textContent = ticket.ticket_number;
            document.getElementById('printCustomerName').textContent = 
                `${ticket.customers.first_name} ${ticket.customers.last_name}`;
            document.getElementById('printDeviceType').textContent = ticket.device_types.name;
            document.getElementById('printDate').textContent = formatDate(ticket.created_at);
            
            // Generate QR code
            const qrDiv = document.getElementById('printQR');
            qrDiv.innerHTML = '';
            QRCode.toCanvas(ticket.ticket_number, { width: 100, margin: 1 }, (err, canvas) => {
                if (!err) qrDiv.appendChild(canvas);
            });
            
            setTimeout(() => window.print(), 500);
        }
        
        // ========================================
        // Open Ticket Detail
        // ========================================
        async function openTicket(ticketId) {
            const modal = document.getElementById('ticketModal');
            const body = document.getElementById('ticketModalBody');
            body.innerHTML = '<div class="loading">Loading...</div>';
            modal.classList.add('active');
            
            const { data: ticket, error } = await db
                .from('tickets')
                .select(`
                    *,
                    customers (*),
                    device_types (name),
                    tech_notes (*, user_id),
                    ticket_parts (*, inventory (name))
                `)
                .eq('id', ticketId)
                .single();
            
            if (error) {
                body.innerHTML = '<p>Error loading ticket</p>';
                return;
            }
            
            // Get customer history
            const { data: history } = await db
                .from('tickets')
                .select('ticket_number, device_types (name), status, created_at')
                .eq('customer_id', ticket.customer_id)
                .neq('id', ticketId)
                .order('created_at', { ascending: false })
                .limit(5);
            
            // Load inventory for parts dropdown
            const { data: inventory } = await db
                .from('inventory')
                .select('id, name, sell_price, quantity')
                .gt('quantity', 0)
                .order('name');
            
            body.innerHTML = `
                <div class="ticket-header">
                    <div>
                        <div class="ticket-number">${ticket.ticket_number}</div>
                        <div class="ticket-meta">Created ${formatDate(ticket.created_at)}</div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary btn-sm" onclick="printTicketFromDetail('${ticketId}')">ð¨ï¸ Print</button>
                        <select class="form-select" style="width: auto;" onchange="updateTicketStatus('${ticketId}', this.value)">
                            <option value="received" ${ticket.status === 'received' ? 'selected' : ''}>Received</option>
                            <option value="diagnosing" ${ticket.status === 'diagnosing' ? 'selected' : ''}>Diagnosing</option>
                            <option value="in_progress" ${ticket.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                            <option value="waiting_parts" ${ticket.status === 'waiting_parts' ? 'selected' : ''}>Waiting for Parts</option>
                            <option value="ready_pickup" ${ticket.status === 'ready_pickup' ? 'selected' : ''}>Ready for Pickup</option>
                            <option value="completed" ${ticket.status === 'completed' ? 'selected' : ''}>Completed</option>
                        </select>
                    </div>
                </div>
                
                <div class="ticket-info">
                    <div class="info-item">
                        <label>Customer</label>
                        <span>${ticket.customers.first_name} ${ticket.customers.last_name}</span>
                    </div>
                    <div class="info-item">
                        <label>Phone</label>
                        <span>${ticket.customers.phone}</span>
                    </div>
                    <div class="info-item">
                        <label>Email</label>
                        <span>${ticket.customers.email || '-'}</span>
                    </div>
                    <div class="info-item">
                        <label>Device</label>
                        <span>${ticket.device_types.name}</span>
                    </div>
                    <div class="info-item">
                        <label>Serial #</label>
                        <span>${ticket.device_serial || '-'}</span>
                    </div>
                    <div class="info-item">
                        <label>Est. Cost</label>
                        <span>${ticket.repair_cost ? '$' + ticket.repair_cost : '-'}</span>
                    </div>
                </div>
                
                ${ticket.issue_description ? `
                <div style="margin-bottom: 24px;">
                    <label style="display: block; font-size: 12px; color: var(--text-light); margin-bottom: 4px;">Issue Description</label>
                    <p>${ticket.issue_description}</p>
                </div>
                ` : ''}
                
                <div class="qr-container">
                    <canvas id="ticketQR"></canvas>
                </div>
                
                <!-- Parts Used -->
                <div style="margin-bottom: 24px;">
                    <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 12px;">Parts Used</label>
                    <div id="partsUsedList">
                        ${ticket.ticket_parts.length ? ticket.ticket_parts.map(p => `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                                <span>${p.inventory.name} (x${p.quantity})</span>
                                <span>$${p.price_charged || 0}</span>
                            </div>
                        `).join('') : '<p style="color: var(--text-light);">No parts used yet</p>'}
                    </div>
                    <div style="margin-top: 12px; display: flex; gap: 10px;">
                        <select id="partSelect" class="form-select" style="flex: 1;">
                            <option value="">Select part...</option>
                            ${inventory ? inventory.map(i => `
                                <option value="${i.id}" data-price="${i.sell_price}">${i.name} (${i.quantity} in stock)</option>
                            `).join('') : ''}
                        </select>
                        <button class="btn btn-secondary btn-sm" onclick="addPartToTicket('${ticketId}')">Add Part</button>
                    </div>
                </div>
                
                <!-- Tech Notes -->
                <div>
                    <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 12px;">Tech Notes</label>
                    <ul class="notes-list" id="notesList">
                        ${ticket.tech_notes.length ? ticket.tech_notes.map(n => `
                            <li class="note-item">
                                <div class="note-meta">${formatDate(n.created_at)}</div>
                                <div class="note-text">${n.note}</div>
                            </li>
                        `).join('') : '<li style="color: var(--text-light);">No notes yet</li>'}
                    </ul>
                    <div style="margin-top: 12px;">
                        <textarea id="newNote" class="form-textarea" placeholder="Add a note..."></textarea>
                        <button class="btn btn-primary btn-sm" style="margin-top: 8px;" onclick="addNote('${ticketId}')">Add Note</button>
                    </div>
                </div>
                
                ${history && history.length ? `
                <div class="history-section">
                    <div class="history-title">Customer History</div>
                    <table>
                        <thead>
                            <tr><th>Ticket</th><th>Device</th><th>Status</th><th>Date</th></tr>
                        </thead>
                        <tbody>
                            ${history.map(h => `
                                <tr class="clickable" onclick="openTicket('${h.id}')">
                                    <td>${h.ticket_number}</td>
                                    <td>${h.device_types.name}</td>
                                    <td><span class="status status-${h.status}">${formatStatus(h.status)}</span></td>
                                    <td>${formatDate(h.created_at)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ` : ''}
            `;
            
            // Generate QR
            QRCode.toCanvas(document.getElementById('ticketQR'), ticket.ticket_number, { width: 120, margin: 1 });
        }
        
        async function printTicketFromDetail(ticketId) {
            const { data: ticket } = await db
                .from('tickets')
                .select(`*, customers (first_name, last_name), device_types (name)`)
                .eq('id', ticketId)
                .single();
            
            if (ticket) printTicketSticker(ticket);
        }
        
        async function updateTicketStatus(ticketId, status) {
            const { error } = await db
                .from('tickets')
                .update({ status })
                .eq('id', ticketId);
            
            if (error) alert('Error updating status');
        }
        
        async function addNote(ticketId) {
            const noteText = document.getElementById('newNote').value.trim();
            if (!noteText) return;
            
            const { error } = await db
                .from('tech_notes')
                .insert({
                    ticket_id: ticketId,
                    user_id: currentUser.id,
                    note: noteText
                });
            
            if (error) {
                alert('Error adding note');
                return;
            }
            
            openTicket(ticketId); // Refresh
        }
        
        async function addPartToTicket(ticketId) {
            const select = document.getElementById('partSelect');
            const partId = select.value;
            if (!partId) return;
            
            const price = select.options[select.selectedIndex].dataset.price;
            
            const { error } = await db
                .from('ticket_parts')
                .insert({
                    ticket_id: ticketId,
                    inventory_id: partId,
                    quantity: 1,
                    price_charged: price
                });
            
            if (error) {
                alert('Error adding part');
                return;
            }
            
            openTicket(ticketId); // Refresh
        }
        
        // ========================================
        // Open Customer
        // ========================================
        async function openCustomer(customerId) {
            document.getElementById('searchResults').classList.remove('active');
            
            // Get customer's tickets
            const { data: tickets } = await db
                .from('tickets')
                .select(`*, device_types (name)`)
                .eq('customer_id', customerId)
                .order('created_at', { ascending: false });
            
            if (tickets && tickets.length) {
                openTicket(tickets[0].id);
            }
        }
        
        // ========================================
        // Inventory
        // ========================================
        async function loadInventory() {
            const { data, error } = await db
                .from('inventory')
                .select('*')
                .order('name');
            
            const tbody = document.getElementById('inventoryTable');
            const alertDiv = document.getElementById('lowStockAlert');
            
            if (error || !data.length) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No inventory items</td></tr>';
                alertDiv.innerHTML = '';
                return;
            }
            
            // Check for low stock
            const lowStock = data.filter(i => i.quantity <= i.min_stock_level);
            if (lowStock.length) {
                alertDiv.innerHTML = `
                    <div class="alert alert-warning" style="margin: 16px;">
                        â ï¸ Low stock: ${lowStock.map(i => i.name).join(', ')}
                    </div>
                `;
            } else {
                alertDiv.innerHTML = '';
            }
            
            tbody.innerHTML = data.map(item => `
                <tr>
                    <td>${item.name}</td>
                    <td>${item.sku || '-'}</td>
                    <td>${item.category || '-'}</td>
                    <td class="${item.quantity <= item.min_stock_level ? 'low-stock' : ''}">${item.quantity}</td>
                    <td>${item.cost_price ? '$' + item.cost_price : '-'}</td>
                    <td>${item.sell_price ? '$' + item.sell_price : '-'}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="editInventory('${item.id}')">Edit</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function showAddInventoryModal() {
            document.getElementById('inventoryModalTitle').textContent = 'Add Part';
            document.getElementById('inventoryForm').reset();
            document.getElementById('inventoryId').value = '';
            document.getElementById('inventoryModal').classList.add('active');
        }
        
        async function editInventory(id) {
            const { data: item } = await db
                .from('inventory')
                .select('*')
                .eq('id', id)
                .single();
            
            if (!item) return;
            
            document.getElementById('inventoryModalTitle').textContent = 'Edit Part';
            document.getElementById('inventoryId').value = item.id;
            document.getElementById('partName').value = item.name;
            document.getElementById('partSku').value = item.sku || '';
            document.getElementById('partCategory').value = item.category || '';
            document.getElementById('partQuantity').value = item.quantity;
            document.getElementById('partMinStock').value = item.min_stock_level;
            document.getElementById('partCost').value = item.cost_price || '';
            document.getElementById('partSellPrice').value = item.sell_price || '';
            
            document.getElementById('inventoryModal').classList.add('active');
        }
        
        async function saveInventory() {
            const id = document.getElementById('inventoryId').value;
            const data = {
                name: document.getElementById('partName').value,
                sku: document.getElementById('partSku').value || null,
                category: document.getElementById('partCategory').value || null,
                quantity: parseInt(document.getElementById('partQuantity').value) || 0,
                min_stock_level: parseInt(document.getElementById('partMinStock').value) || 5,
                cost_price: parseFloat(document.getElementById('partCost').value) || null,
                sell_price: parseFloat(document.getElementById('partSellPrice').value) || null
            };
            
            let error;
            if (id) {
                ({ error } = await db.from('inventory').update(data).eq('id', id));
            } else {
                ({ error } = await db.from('inventory').insert(data));
            }
            
            if (error) {
                alert('Error saving: ' + error.message);
                return;
            }
            
            closeModal('inventoryModal');
            loadInventory();
        }
        
        // ========================================
        // Statistics
        // ========================================
        async function loadStatistics() {
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay());
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            // Get counts
            const { count: totalTickets } = await db
                .from('tickets')
                .select('*', { count: 'exact', head: true });
            
            const { count: weekTickets } = await db
                .from('tickets')
                .select('*', { count: 'exact', head: true })
                .gte('created_at', startOfWeek.toISOString());
            
            const { count: monthTickets } = await db
                .from('tickets')
                .select('*', { count: 'exact', head: true })
                .gte('created_at', startOfMonth.toISOString());
            
            const { data: revenueData } = await db
                .from('tickets')
                .select('repair_cost')
                .eq('status', 'completed')
                .gte('created_at', startOfMonth.toISOString());
            
            const monthRevenue = revenueData ? revenueData.reduce((sum, t) => sum + (parseFloat(t.repair_cost) || 0), 0) : 0;
            
            document.getElementById('statsCards').innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total Tickets</div>
                    <div class="stat-value">${totalTickets || 0}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">This Week</div>
                    <div class="stat-value">${weekTickets || 0}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">This Month</div>
                    <div class="stat-value">${monthTickets || 0}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Month Revenue</div>
                    <div class="stat-value success">$${monthRevenue.toFixed(2)}</div>
                </div>
            `;
            
            // Device breakdown
            const { data: deviceData } = await db
                .from('tickets')
                .select('device_types (name)')
                .gte('created_at', startOfMonth.toISOString());
            
            const deviceCounts = {};
            deviceData?.forEach(t => {
                const name = t.device_types.name;
                deviceCounts[name] = (deviceCounts[name] || 0) + 1;
            });
            
            const sortedDevices = Object.entries(deviceCounts).sort((a, b) => b[1] - a[1]);
            
            document.getElementById('deviceStats').innerHTML = sortedDevices.length ? `
                <table>
                    <thead><tr><th>Device</th><th>Repairs</th></tr></thead>
                    <tbody>
                        ${sortedDevices.map(([name, count]) => `
                            <tr><td>${name}</td><td>${count}</td></tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p>No data for this month</p>';
            
            // Recent completed
            const { data: completed } = await db
                .from('tickets')
                .select(`ticket_number, repair_cost, completed_at, device_types (name)`)
                .eq('status', 'completed')
                .order('completed_at', { ascending: false })
                .limit(10);
            
            document.getElementById('completedList').innerHTML = completed?.length ? `
                <table>
                    <thead><tr><th>Ticket</th><th>Device</th><th>Amount</th></tr></thead>
                    <tbody>
                        ${completed.map(t => `
                            <tr>
                                <td>${t.ticket_number}</td>
                                <td>${t.device_types.name}</td>
                                <td>${t.repair_cost ? '$' + t.repair_cost : '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p>No completed repairs yet</p>';
        }
        
        // ========================================
        // Utilities
        // ========================================
        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('en-US', {
                month: 'short', day: 'numeric', year: 'numeric'
            });
        }
        
        function formatStatus(status) {
            const labels = {
                received: 'Received',
                diagnosing: 'Diagnosing',
                in_progress: 'In Progress',
                waiting_parts: 'Waiting for Parts',
                ready_pickup: 'Ready for Pickup',
                completed: 'Completed'
            };
            return labels[status] || status;
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
        
        // Close modal on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.classList.remove('active');
            });
        });
        
        // ========================================
        // Initialize
        // ========================================
        checkAuth();
    </script>
</body>
</html>
